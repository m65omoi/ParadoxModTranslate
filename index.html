<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>钢四汉化助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f1f5f9;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(203, 213, 225, 0.6);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #entriesContainer {
            content-visibility: auto;
            contain-intrinsic-size: 120px;
        }

        .anim-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen text-slate-800 pb-10">

    <div class="max-w-[1600px] mx-auto px-6 py-6">
        <nav class="glass-panel sticky top-4 z-50 px-6 py-4 rounded-2xl shadow-lg flex flex-wrap items-center justify-between gap-6 mb-8">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200">
                    <i class="fas fa-microchip text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Hoi4 AI翻译 <span class="text-blue-600"></span></h1>
                    <p id="fileSummary" class="text-xs text-slate-500 font-medium mt-1 uppercase tracking-wider"></p>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center bg-slate-100 p-1.5 rounded-xl border border-slate-200 text-sm font-semibold">
                    <select id="sourceLangSelect" class="bg-transparent px-3 py-1 outline-none cursor-pointer hover:text-blue-600">
                        <option value="English">源：英语</option>
                        <option value="Korean">源：韩语</option>
                        <option value="Japanese">源：日语</option>
                        <option value="Chinese (Simplified)">源：简体中文</option>
                    </select>
                    <i class="fas fa-arrow-right mx-2 text-slate-400 text-xs"></i>
                    <select id="targetLangSelect" class="bg-transparent px-3 py-1 outline-none cursor-pointer hover:text-blue-600">
                        <option value="Chinese (Simplified)">目标：简体中文</option>
                        <option value="Chinese (Traditional)">目标：繁体中文</option>
                        <option value="English">目标：英语</option>
                    </select>
                </div>

                <div class="flex items-center gap-3">
                    <button id="btnSetKey" class="flex items-center gap-2 bg-slate-800 text-white px-4 py-2.5 rounded-xl hover:bg-black transition-all text-sm font-bold shadow-sm">
                        <i class="fas fa-key text-yellow-400"></i>
                        <span>DeepSeek 设置</span>
                    </button>

                    <label class="flex items-center gap-2 bg-white border border-slate-300 px-5 py-2.5 rounded-xl cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all text-sm font-bold shadow-sm">
                        <i class="fas fa-upload text-blue-500"></i>
                        <span>上传 YML</span>
                        <input type="file" id="fileInput" class="hidden" accept=".yml">
                    </label>

                    <div class="flex gap-2">
                        <button id="btnTranslate" disabled class="flex items-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-xl hover:bg-blue-700 active:scale-95 disabled:opacity-30 disabled:pointer-events-none transition-all shadow-lg shadow-blue-100 text-sm font-bold">
                            <i class="fas fa-brain"></i> 智能翻译
                        </button>
                        <button id="btnAbort" class="hidden flex items-center gap-2 bg-red-500 text-white px-6 py-2.5 rounded-xl hover:bg-red-600 active:scale-95 transition-all shadow-lg shadow-red-100 text-sm font-bold">
                            <i class="fas fa-stop"></i> 停止
                        </button>
                    </div>
                    
                    <button id="btnExport" disabled class="flex items-center gap-2 bg-emerald-600 text-white px-6 py-2.5 rounded-xl hover:bg-emerald-700 active:scale-95 disabled:opacity-30 transition-all shadow-lg shadow-emerald-100 text-sm font-bold">
                        <i class="fas fa-save"></i> 导出文件
                    </button>
                </div>
            </div>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <aside class="lg:col-span-3 space-y-6">
                <!-- 背景资料模块 -->
                <div class="glass-panel p-6 rounded-3xl shadow-sm border-l-4 border-l-amber-400">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">背景知识库（可选填）</h3>
                        <i class="fas fa-book text-amber-500"></i>
                    </div>
                    <p class="text-[10px] text-slate-400 mb-3 leading-tight">在此输入模组历史、国家设定或术语对照，AI 将根据此资料进行翻译。</p>
                    <textarea id="contextInput" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-amber-500/20 focus:border-amber-400 outline-none transition-all h-32 resize-none custom-scrollbar" placeholder="例如：这是一个关于第二次世界大战同盟国战败后的架空历史模组... 德国现在被称为大德意志意志帝国..."></textarea>
                </div>

                <div class="glass-panel p-6 rounded-3xl shadow-sm">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">内容搜索</h3>
                    <div class="relative group">
                        <i class="fas fa-search absolute left-4 top-3.5 text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
                        <input type="text" id="searchInput" placeholder="搜索键名或文本..." class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                    
                    <div class="mt-6 space-y-2">
                        <button id="filterAll" class="w-full text-left px-4 py-3 rounded-xl text-sm font-bold bg-blue-600 text-white shadow-md shadow-blue-100 transition-all">显示全部条目</button>
                        <button id="filterEmpty" class="w-full text-left px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-white border border-transparent hover:border-slate-200 transition-all">仅看未翻译</button>
                    </div>
                </div>

                <div id="progressBox" class="glass-panel p-6 rounded-3xl shadow-sm hidden">
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-sm font-bold text-blue-600">翻译进度</span>
                        <span id="progressPercent" class="text-lg font-black font-mono">0%</span>
                    </div>
                    <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden shadow-inner">
                        <div id="progressBar" class="h-full bg-blue-500 shadow-lg transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progressDetail" class="text-[10px] text-slate-400 mt-3 text-center font-bold uppercase tracking-tighter"></p>
                </div>
            </aside>

            <main class="lg:col-span-9">
                <div class="glass-panel rounded-3xl shadow-xl min-h-[75vh] flex flex-col overflow-hidden border border-white">
                    <div class="px-8 py-4 border-b border-slate-100 flex justify-between items-center bg-white/50">
                        <h2 class="text-sm font-bold text-slate-500 flex items-center gap-2">
                            <i class="fas fa-list-ul text-blue-500"></i> 本地化条目预览
                        </h2>
                        <span id="renderInfo" class="text-xs text-slate-400 font-mono font-medium"></span>
                    </div>

                    <div id="entriesContainer" class="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-6 max-h-[80vh]">
                        <div id="emptyState" class="flex flex-col items-center justify-center py-40 text-slate-300">
                            <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                                <i class="fas fa-file-invoice text-4xl opacity-20"></i>
                            </div>
                            <p class="text-lg font-bold">请上传 HOI4 本地化文件 (.yml)</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- API Key Setting Modal -->
    <div id="keyModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 transform transition-all">
            <h3 class="text-xl font-bold mb-2">设置 DeepSeek API 密钥</h3>
            <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider font-bold">连接 DeepSeek AI 引擎</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-black text-slate-500 mb-2 uppercase">DeepSeek API Key</label>
                    <input type="password" id="inputApiKey" placeholder="sk-..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all font-mono">
                </div>
                <p class="text-[10px] text-slate-400 leading-relaxed italic">
                    提示：请访问 <a href="https://platform.deepseek.com/" target="_blank" class="text-blue-500 underline">DeepSeek Platform</a> 获取密钥。
                </p>
                <div class="flex gap-3 pt-4">
                    <button id="btnSaveKey" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">保存设置</button>
                    <button id="btnCloseModal" class="px-6 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition-all">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let activeApiKey = localStorage.getItem('hoi4_deepseek_apikey') || "";
        let isAborting = false; 
        
        const container = document.getElementById('entriesContainer');
        const fileInput = document.getElementById('fileInput');
        const btnTranslate = document.getElementById('btnTranslate');
        const btnAbort = document.getElementById('btnAbort');
        const btnExport = document.getElementById('btnExport');
        const searchInput = document.getElementById('searchInput');
        const contextInput = document.getElementById('contextInput');
        const keyModal = document.getElementById('keyModal');

        let allEntries = [];
        let filteredEntries = [];
        let currentFileName = "";
        let filterMode = 'all';
        let pageSize = 30;
        let currentPage = 1;

        // 加载保存的背景资料
        contextInput.value = localStorage.getItem('hoi4_mod_context') || "";
        contextInput.oninput = () => localStorage.setItem('hoi4_mod_context', contextInput.value);

        document.getElementById('btnSetKey').onclick = () => {
            document.getElementById('inputApiKey').value = activeApiKey;
            keyModal.classList.remove('hidden');
        };
        document.getElementById('btnCloseModal').onclick = () => keyModal.classList.add('hidden');
        document.getElementById('btnSaveKey').onclick = () => {
            const val = document.getElementById('inputApiKey').value.trim();
            activeApiKey = val;
            localStorage.setItem('hoi4_deepseek_apikey', val);
            keyModal.classList.add('hidden');
        };

        btnAbort.onclick = () => {
            isAborting = true;
            btnAbort.innerText = "正在停止...";
            btnAbort.disabled = true;
        };

        function parseYml(text) {
            const lines = text.split('\n');
            let detectedLang = "English";
            const result = [];
            const langLine = lines[0].match(/l_(\w+):/);
            if (langLine) {
                const map = { 'english': 'English', 'japanese': 'Japanese', 'korean': 'Korean' };
                detectedLang = map[langLine[1]] || "English";
            }

            const entryRegex = /^\s*([\w.]+):(\d+)?\s*"(.*)"\s*$/;
            for (let i = 1; i < lines.length; i++) {
                const match = lines[i].match(entryRegex);
                if (match) {
                    result.push({
                        key: match[1],
                        ver: match[2] || "0",
                        src: match[3],
                        dst: "",
                        status: 'idle'
                    });
                }
            }
            return { detectedLang, result };
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const { detectedLang, result } = parseYml(event.target.result);
                allEntries = result;
                filteredEntries = [...allEntries];
                currentFileName = file.name;
                document.getElementById('sourceLangSelect').value = detectedLang;
                document.getElementById('fileSummary').innerText = `${file.name} - 共 ${result.length} 条数据`;
                
                resetAndRender();
                btnTranslate.disabled = false;
                btnExport.disabled = false;
            };
            reader.readAsText(file);
        });

        function resetAndRender() {
            container.innerHTML = '';
            currentPage = 1;
            applyFilter();
            renderNextBatch();
        }

        function applyFilter() {
            const query = searchInput.value.toLowerCase();
            filteredEntries = allEntries.filter(e => {
                const matchSearch = !query || e.key.toLowerCase().includes(query) || e.src.toLowerCase().includes(query);
                const matchEmpty = filterMode === 'all' || (filterMode === 'empty' && !e.dst);
                return matchSearch && matchEmpty;
            });
            document.getElementById('renderInfo').innerText = `显示: ${filteredEntries.length} / 总计: ${allEntries.length}`;
        }

        function renderNextBatch() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const batch = filteredEntries.slice(start, end);

            if (batch.length === 0 && currentPage === 1) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400 text-sm font-medium">未找到匹配条目</div>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            batch.forEach((item) => {
                const realIndex = allEntries.indexOf(item);
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:border-blue-300 transition-all group";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-mono font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100 truncate max-w-[80%] group-hover:text-blue-500 transition-colors">${item.key}</span>
                        <div id="status-${realIndex}" class="text-[10px] font-black uppercase px-2 py-1 rounded-full shadow-sm ${getStatusStyle(item.status)}">${item.status}</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-[13px] text-slate-600 bg-slate-50/80 p-4 rounded-xl border border-slate-100 leading-relaxed min-h-[60px] whitespace-pre-wrap">${item.src}</div>
                        <textarea oninput="updateItem(${realIndex}, this.value)" class="text-[13px] p-4 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 resize-none h-[60px] transition-all bg-white shadow-inner" placeholder="等待翻译...">${item.dst}</textarea>
                    </div>
                `;
                fragment.appendChild(div);
            });

            container.appendChild(fragment);
            currentPage++;
        }

        function getStatusStyle(s) {
            if (s === 'done') return 'bg-emerald-100 text-emerald-700 border border-emerald-200';
            if (s === 'loading') return 'bg-blue-100 text-blue-700 border border-blue-200 anim-pulse';
            if (s === 'error') return 'bg-red-100 text-red-700 border border-red-200';
            return 'bg-slate-100 text-slate-500 border border-slate-200';
        }

        function updateItem(idx, val) {
            allEntries[idx].dst = val;
            allEntries[idx].status = val ? 'done' : 'idle';
            const badge = document.getElementById(`status-${idx}`);
            if (badge) {
                badge.innerText = allEntries[idx].status;
                badge.className = `text-[10px] font-black uppercase px-2 py-1 rounded-full shadow-sm ${getStatusStyle(allEntries[idx].status)}`;
            }
        }

        container.addEventListener('scroll', () => {
            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
                if ((currentPage - 1) * pageSize < filteredEntries.length) renderNextBatch();
            }
        });

        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function translateWithDeepSeek(text, source, target, modContext, retry = 0) {
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${activeApiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { 
                                role: "system", 
                                content: `You are a professional game translator for Hearts of Iron IV. Translate mod text from ${source} to ${target}. 
                                ${modContext ? `\nMOD CONTEXT / BACKGROUND:\n${modContext}\n` : ''}
                                Rules:
                                1. Strictly keep all format codes like §Y, §G, §!, [Root.GetName], etc.
                                2. Maintain game-specific terminology correctly according to HOI4 standards.
                                3. Output ONLY the translated text without explanations.` 
                            },
                            { role: "user", content: text }
                        ],
                        temperature: 0.1
                    })
                });

                if (response.status === 429) {
                    if (retry < 5) {
                        const waitTime = Math.pow(2, retry) * 2000;
                        await sleep(waitTime);
                        return translateWithDeepSeek(text, source, target, modContext, retry + 1);
                    }
                    throw new Error('RATE_LIMIT');
                }

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error?.message || `API_ERROR_${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (e) {
                if (retry < 3 && e.message !== 'RATE_LIMIT') {
                    await sleep(1000);
                    return translateWithDeepSeek(text, source, target, modContext, retry + 1);
                }
                throw e;
            }
        }

        btnTranslate.onclick = async () => {
            if (!activeApiKey) {
                alert("请先设置 DeepSeek API Key！");
                keyModal.classList.remove('hidden');
                return;
            }

            const sL = document.getElementById('sourceLangSelect').value;
            const tL = document.getElementById('targetLangSelect').value;
            const modContext = contextInput.value.trim();
            const list = allEntries.filter(e => !e.dst);
            
            if (!list.length) return;

            isAborting = false;
            btnTranslate.disabled = true;
            btnAbort.classList.remove('hidden');
            btnAbort.disabled = false;
            btnAbort.innerText = "停止";
            document.getElementById('progressBox').classList.remove('hidden');

            let doneCount = allEntries.length - list.length;
            
            for (let item of list) {
                if (isAborting) break;

                const idx = allEntries.indexOf(item);
                const badge = document.getElementById(`status-${idx}`);
                const ta = badge?.parentElement.nextElementSibling.querySelector('textarea');
                
                try {
                    item.status = 'loading';
                    updateBadge(badge, 'loading', 'translating...');

                    const res = await translateWithDeepSeek(item.src, sL, tL, modContext);
                    item.dst = res;
                    item.status = 'done';
                    if (ta) ta.value = res;
                    
                    await sleep(100); 

                } catch (e) {
                    console.error(e);
                    item.status = 'error';
                }

                updateBadge(badge, item.status, item.status);
                doneCount++;
                const p = Math.round((doneCount / allEntries.length) * 100);
                document.getElementById('progressBar').style.width = p + '%';
                document.getElementById('progressPercent').innerText = p + '%';
                document.getElementById('progressDetail').innerText = `${doneCount} / ${allEntries.length} 完成`;
                
                if (item.status === 'error' && !isAborting) {
                    if (!confirm("翻译中途出错。是否继续尝试下一条？取消将停止任务。")) break;
                }
            }

            btnTranslate.disabled = false;
            btnAbort.classList.add('hidden');
            if (isAborting) {
                document.getElementById('progressDetail').innerText += " (已手动停止)";
            }
        };

        function updateBadge(badge, status, text) {
            if (badge) {
                badge.innerText = text;
                badge.className = `text-[10px] font-black uppercase px-2 py-1 rounded-full shadow-sm ${getStatusStyle(status)}`;
            }
        }

        btnExport.onclick = () => {
            const rawTL = document.getElementById('targetLangSelect').value;
            const langCodeMap = { 'Chinese (Simplified)': 'simp_chinese', 'Chinese (Traditional)': 'traditional_chinese', 'English': 'english' };
            const tCode = langCodeMap[rawTL] || 'simp_chinese';

            let out = `l_${tCode}:\n`;
            allEntries.forEach(e => {
                out += ` ${e.key}:${e.ver} "${e.dst || e.src}"\n`;
            });
            const blob = new Blob(['\ufeff' + out], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = currentFileName.replace(/l_\w+/, `l_${tCode}`);
            link.click();
        };

        document.getElementById('filterAll').onclick = function() {
            filterMode = 'all';
            this.className = "w-full text-left px-4 py-3 rounded-xl text-sm font-bold bg-blue-600 text-white shadow-md shadow-blue-100 transition-all";
            document.getElementById('filterEmpty').className = "w-full text-left px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-white border border-transparent hover:border-slate-200 transition-all";
            resetAndRender();
        };
        document.getElementById('filterEmpty').onclick = function() {
            filterMode = 'empty';
            this.className = "w-full text-left px-4 py-3 rounded-xl text-sm font-bold bg-blue-600 text-white shadow-md shadow-blue-100 transition-all";
            document.getElementById('filterAll').className = "w-full text-left px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-white border border-transparent hover:border-slate-200 transition-all";
            resetAndRender();
        };
        searchInput.oninput = () => {
            clearTimeout(window.searchT);
            window.searchT = setTimeout(resetAndRender, 300);
        };
    </script>
</body>
</html>
